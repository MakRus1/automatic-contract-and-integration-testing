name: CI - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  build-and-test:
    name: –°–±–æ—Ä–∫–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        build_type: [Debug, Release]
        
    steps:
    - name: Checkout –∫–æ–¥–∞
      uses: actions/checkout@v4

    - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ ninja-build

    - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install cmake ninja

    - name: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ CMake build
      uses: actions/cache@v3
      with:
        path: build
        key: ${{ runner.os }}-${{ matrix.build_type }}-build-${{ hashFiles('**/CMakeLists.txt') }}
        restore-keys: |
          ${{ runner.os }}-${{ matrix.build_type }}-build-

    - name: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è CMake
      run: |
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
          -DCMAKE_CXX_STANDARD=17

    - name: –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
      run: cmake --build build --config ${{ matrix.build_type }}

    - name: –ó–∞–ø—É—Å–∫ Unit —Ç–µ—Å—Ç–æ–≤
      working-directory: build
      run: |
        echo "üß™ –ó–∞–ø—É—Å–∫ Unit —Ç–µ—Å—Ç–æ–≤..."
        ./unit_tests --gtest_output=xml:unit_test_results.xml

    - name: –ó–∞–ø—É—Å–∫ –ö–æ–Ω—Ç—Ä–∞–∫—Ç–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
      working-directory: build
      run: |
        echo "üìã –ó–∞–ø—É—Å–∫ –ö–æ–Ω—Ç—Ä–∞–∫—Ç–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤..."
        ./contract_tests --gtest_output=xml:contract_test_results.xml

    - name: –ó–∞–ø—É—Å–∫ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
      working-directory: build
      run: |
        echo "üîó –ó–∞–ø—É—Å–∫ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤..."
        ./integration_tests --gtest_output=xml:integration_test_results.xml

    - name: –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–æ–≤
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.os }}-${{ matrix.build_type }}
        path: build/*_test_results.xml

  # –û—Ç–¥–µ–ª—å–Ω—ã–π job –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–¥–∞
  code-analysis:
    name: –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout –∫–æ–¥–∞
      uses: actions/checkout@v4

    - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞
      run: |
        sudo apt-get update
        sudo apt-get install -y cppcheck cmake g++

    - name: –ó–∞–ø—É—Å–∫ cppcheck
      run: |
        cppcheck --enable=all --inconclusive --std=c++17 \
          --suppress=missingIncludeSystem \
          --suppress=unusedFunction \
          --suppress=functionStatic \
          --suppress=unmatchedSuppression \
          --error-exitcode=1 \
          -I include src/
      continue-on-error: true

    - name: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è CMake –¥–ª—è compile_commands.json
      run: cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

  # Job –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞ –æ –ø–æ–∫—Ä—ã—Ç–∏–∏ (—Ç–æ–ª—å–∫–æ –Ω–∞ Linux)
  coverage:
    name: –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout –∫–æ–¥–∞
      uses: actions/checkout@v4

    - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ ninja-build lcov

    - name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ lcov
      run: |
        # –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è lcov
        echo "geninfo_unexecuted_blocks = 1" > ~/.lcovrc
        echo "branch_coverage = 0" >> ~/.lcovrc

    - name: –°–±–æ—Ä–∫–∞ —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º
      run: |
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_CXX_FLAGS="-O0 -g --coverage -fprofile-arcs -ftest-coverage -fno-inline"
        cmake --build build

    - name: –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
      working-directory: build
      run: |
        ./unit_tests
        ./contract_tests
        ./integration_tests

    - name: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ –æ –ø–æ–∫—Ä—ã—Ç–∏–∏
      continue-on-error: true
      run: |
        lcov --capture --directory build --output-file coverage.info \
          --ignore-errors mismatch,mismatch \
          --ignore-errors inconsistent,inconsistent \
          --ignore-errors gcov,gcov \
          --rc geninfo_unexecuted_blocks=1
        lcov --remove coverage.info '/usr/*' '*/googletest/*' '*/_deps/*' --output-file coverage.info \
          --ignore-errors mismatch,mismatch \
          --ignore-errors inconsistent,inconsistent \
          --ignore-errors unused,unused
        lcov --list coverage.info --ignore-errors mismatch,mismatch || true

    - name: –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á–µ—Ç–∞ –æ –ø–æ–∫—Ä—ã—Ç–∏–∏
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report
        path: coverage.info
        if-no-files-found: ignore

  # –ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å
  test-summary:
    name: –ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å
    needs: [build-and-test, code-analysis, coverage]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Ç–µ—Å—Ç–æ–≤
      run: |
        echo "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:"
        echo "  - –°–±–æ—Ä–∫–∞ –∏ —Ç–µ—Å—Ç—ã: ${{ needs.build-and-test.result }}"
        echo "  - –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑: ${{ needs.code-analysis.result }}"
        echo "  - –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞: ${{ needs.coverage.result }}"
        
        if [ "${{ needs.build-and-test.result }}" == "success" ]; then
          echo ""
          echo "‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!"
        else
          echo ""
          echo "‚ùå –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å"
          exit 1
        fi

